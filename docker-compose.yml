services:
  tailscale:
    image: tailscale/tailscale:v1.78.1
    hostname: tailscale
    networks:
      proxy_net:
        aliases:
          - tailscale
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY}
      - TS_EXTRA_ARGS=--exit-node=${TS_EXIT_NODE}
      - TS_SOCKS5_SERVER=:1080
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=true
      - TS_ACCEPT_DNS=true
      - TS_AUTH_ONCE=true
      - TS_ENABLE_HEALTH_CHECK=true
      - TS_LOCAL_ADDR_PORT=0.0.0.0:9002
    volumes:
      - tailscale-state:/var/lib/tailscale
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9002/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          memory: 128M

  test:
    build: .
    environment:
      - TAILSCALE_PROXY_URL=socks5://tailscale:1080
      - PCSE_USERNAME=${PCSE_USERNAME}
      - PCSE_PASSWORD=${PCSE_PASSWORD}
      - PCSE_PRACTICE_CODE=${PCSE_PRACTICE_CODE}
      - HEADLESS=true
    depends_on:
      tailscale:
        condition: service_healthy
    networks:
      - proxy_net
    volumes:
      - ./screenshots:/app/screenshots

networks:
  proxy_net:
    driver: bridge

volumes:
  tailscale-state:
